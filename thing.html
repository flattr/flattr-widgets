<!DOCTYPE html>

<html>
	<head>
		<style rel="stylesheet" type="text/css">
			body {
				width: 292px;
			}
			body, * {
				margin: 0;
				padding: 0;
				font-family: "lucida grande",tahoma,verdana,arial,sans-serif;
				line-height: 1.28;
				font-size: 11px;
			}
			a {
				color: #666;
				text-decoration: none;
			}
			a:hover {
				text-decoration: underline;
			}
			#wrapper {
				border: 1px solid #ccc;
			}
			.user {
				display: inline-block;
				width: 50px;
				height: 70px;
				margin-right: 5px;
				vertical-align: top;
				text-align: center;
				overflow: hidden;
			}
			.user:nth-child(5n) {
				margin-right: 0;
			}
			.user img {
				background: #ccc;
				width: 48px;
				height: 48px;
				margin-right: 5px;
			}
			.user span {
				font-size: 9px;
			}
            .section {
				margin: 10px;
            }
            .section.header {
                margin: 0;
                padding-bottom: 10px;
				padding: 10px;
                background: rgb(249, 248, 238);
                border-bottom: 1px solid rgb(239, 235, 224);
                color: #666;
            }
            .section.header span {
                font-size: 14px;
                font-weight: bold;
            }
			.section.top .title-and-button {
				margin-left: 5px;
				vertical-align: top;
				display: inline-block;
				max-width: 219px;
			}
			.section.top .title {
				display: block;
				font-weight: bold;
				font-size: 16px;
			}
			.section.top .logo {
				border: 1px solid #ccc;
				display: inline-block;
				vertical-align: top;
			}
			.section.top .logo img {
				vertical-align: top;
			}
			.section.top .logo:hover {
				text-decoration: none;
			}
			.section.people {
				min-height: 100px;
				border-top: 1px solid #ccc;
				border-bottom: 1px solid #ccc;
				padding-top: 5px;
			}
            .section.footer a {
                padding-left: 20px;
                background: url(http://flattr.com/_img/favicon.ico) no-repeat center left;
                display: block;
                line-height: 16px;
            }
		</style>
	</head>
	<body>
		<div id="wrapper">
            <div class="section header">
                <span>Support us</span>
            </div>
			<div class="section top">
				<a class="logo" href="#" target="_blank">
				</a>
				<div class="title-and-button">
					<a class="title" href="#" target="_blank"></a>
					<a class="FlattrButton" rev="flattr;button:compact" href="#"></a>
				</div>
			</div>
			<ul class="section people">
			</ul>
			<div class="section footer">
				<a href="https://flattr.com/" target="_blank">Flattr - Social micro-donations</a>
			</div>
		</div>
        <script type="text/javascript">
			var showHeader = location.href.indexOf('noheader') === -1;

			if (!showHeader) {
				document.querySelector('.section.header').style.display = 'none';
			}

            function injectFlattrScript() {
                var s = document.createElement('script');
                var t = document.getElementsByTagName('script')[0];

                s.type = 'text/javascript';
                s.async = true;
                s.src = 'http://api.flattr.com/js/0.6/load.js?mode=auto';

                t.parentNode.insertBefore(s, t);
            }

            function extractThingIdFromUrl(url) {
				var matches = url.match('thing=([0-9]*)');
				var ret = false;
				if (matches && matches.length === 2) {
					ret = matches[1];
				}
				return ret;
            }

			var thingId = extractThingIdFromUrl(location.href);
            var xhr = new XMLHttpRequest();
            var url = 'https://api.flattr.com/rest/v2/things/' + thingId;

            xhr.open('GET', url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200 || xhr.status == 304) {
                    var response = JSON.parse(xhr.responseText);

					document.querySelector('.top .title').innerHTML = response.title;
					document.querySelector('.top .title').setAttribute('href', response.link);
					document.querySelector('.top .logo').setAttribute('href', response.link);
					document.querySelector('.top .FlattrButton').setAttribute('href', response['url']);

					var img = document.createElement('img');
					img.setAttribute('width', '40');
					img.setAttribute('height', '40');
					img.setAttribute('src', response.image);

					document.querySelector('.top .logo').appendChild(img);

                    injectFlattrScript();
					loadLatestSupporters(thingId);
                }
            };
            xhr.send();

			function createUserHtml(user) {
				var a = document.createElement('a');
				var img = document.createElement('img');
				var username = document.createElement('span');

				a.setAttribute('href', user.link);
				a.setAttribute('target', '_blank');
				a.setAttribute('class', 'user');
				img.setAttribute('src', user.avatar);
				username.innerHTML = user.firstname || user.username;

				a.appendChild(img);
				a.appendChild(username);

				return a;
			}

			function loadLatestSupporters(thingId) {
				var xhr = new XMLHttpRequest();
				var url = 'https://api.flattr.com/rest/v2/things/' + thingId + '/flattrs?full';

				xhr.open('GET', url, true);
				xhr.onreadystatechange = function() {
					if (xhr.readyState == 4 && xhr.status == 200 || xhr.status == 304) {
						var response = JSON.parse(xhr.responseText);
						var i = 0;
						var user;
						var fragment = document.createDocumentFragment();
						var addedUsers = 0;
						for (i = 0; i < response.length; i += 1) {
							user = response[i]['owner'];
							if (user.avatar) {
								fragment.appendChild(createUserHtml(user));
								addedUsers += 1;
								if (addedUsers === 15) {
									break;
								}
							}
						}
						document.querySelector('.section.people').appendChild(fragment);
					}
				};

				xhr.send();
			}
        </script>
	</body>
</html>
